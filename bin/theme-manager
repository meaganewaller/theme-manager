#!/usr/bin/env bash
set -euo pipefail

VERSION="0.1.0"

# ------------------------------------------------------------------------------
# Paths
# ------------------------------------------------------------------------------
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"
THEMES_DIR="$ROOT_DIR/themes"
APPLY_DIR="$ROOT_DIR/apply"
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/theme-manager"
STATE_FILE="$CONFIG_DIR/current-theme"
DRY_RUN=false
DIFF=false

# ------------------------------------------------------------------------------
# Helpers
# ------------------------------------------------------------------------------

die() {
    echo "theme-manager: $*"
    exit 1
}

require() {
  command -v "$1" >/dev/null 2>&1 || die "missing required dependency: $1"
}

usage() {
  cat <<EOF
theme-manager v$VERSION

Usage:
  theme-manager list
  theme-manager current
  theme-manager doctor
  theme-manager version
  theme-manager apply [--dry-run | --diff] <theme>
  theme-manager explain <theme>

Commands:
  list        List available themes
  current     Show currently applied theme
  doctor      Check for common issues
  version     Show version information
  apply       Apply a theme (--dry-run: show plan only; --diff: show JSON diff vs current)
  explain     Print the resolved theme JSON

EOF
}

# ------------------------------------------------------------------------------
# Preconditions
# ------------------------------------------------------------------------------

require jq

mkdir -p "$CONFIG_DIR"

# ------------------------------------------------------------------------------
# Commands
# ------------------------------------------------------------------------------

cmd_list() {
  ls -1 "$THEMES_DIR" | sed 's/^/ - /'
}

cmd_current() {
  if [[ -f "$STATE_FILE" ]]; then
    cat "$STATE_FILE"
  else
    echo "(none)"
  fi
}

cmd_doctor() {
  echo "theme-manager doctor"
  echo

  echo "→ Checking dependencies"
  command -v jq >/dev/null && echo "✓ jq found" || echo "✗ jq missing"

  echo
  echo "→ Checking directories"
  [[ -d "$THEMES_DIR" ]] && echo "✓ themes directory" || echo "✗ themes directory missing"
  [[ -d "$APPLY_DIR" ]] && echo "✓ apply scripts directory" || echo "✗ apply scripts directory missing"

  echo
  echo "→ Checking apply scripts"
  for script in "$APPLY_DIR"/*.sh; do
    [[ -x "$script" ]] && echo "✓ $(basename "$script") executable" \
                      || echo "✗ $(basename "$script") not executable"
  done

  echo
  echo "→ Checking state"
  if [[ -f "$STATE_FILE" ]]; then
    echo "✓ current theme: $(cat "$STATE_FILE")"
  else
    echo "ℹ no theme applied yet"
  fi

  echo
  echo "✓ Doctor complete"
}

cmd_version() {
  echo "theme-manager v$VERSION"
}

resolve_theme() {
  local theme="$1"
  local theme_file="$THEMES_DIR/$theme/theme.json"

  [[ -f "$theme_file" ]] || die "theme not found: $theme"

  jq empty "$theme_file" || die "invalid JSON in theme: $theme"

  validate_theme "$theme_file"

  cat "$theme_file"
}


cmd_explain() {
  local theme="${1:-}"
  [[ -n "$theme" ]] || die "theme name required"

  resolve_theme "$theme" | jq .
}

cmd_apply() {
  local theme=""
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --dry-run)
        DRY_RUN=true
        shift
        ;;
      --diff)
        DIFF=true
        shift
        ;;
      *)
        theme="$1"
        shift
        ;;
    esac
  done

  [[ -n "$theme" ]] || die "theme name required"

  local tmp
  tmp="$(mktemp)"
  trap 'rm -f "$tmp"' EXIT

  resolve_theme "$theme" > "$tmp"

  if [[ "$DIFF" == true ]]; then
    local current_name
    current_name=""
    [[ -f "$STATE_FILE" ]] && current_name="$(cat "$STATE_FILE")"
    if [[ -z "$current_name" ]]; then
      echo "→ No current theme to compare."
      echo
      echo "Resolved theme for '$theme':"
      jq . "$tmp"
      return 0
    fi
    local current_tmp
    current_tmp="$(mktemp)"
    trap 'rm -f "$tmp" "$current_tmp"' EXIT
    if ! resolve_theme "$current_name" > "$current_tmp" 2>/dev/null; then
      echo "→ Current theme '$current_name' could not be resolved (theme missing or invalid)."
      echo
      echo "Resolved theme for '$theme':"
      jq . "$tmp"
      rm -f "$current_tmp"
      return 0
    fi
    echo "→ Diff: current ($current_name) → $theme"
    echo
    diff -u <(jq -S . "$current_tmp") <(jq -S . "$tmp") || true
    rm -f "$current_tmp"
    return 0
  fi

  if [[ "$DRY_RUN" == true ]]; then
    echo "→ Dry run: theme '$theme'"
    echo
    echo "Resolved theme:"
    jq . "$tmp"
    echo
    echo "Apply scripts that would run:"
    for script in "$APPLY_DIR"/*.sh; do
      [[ -x "$script" ]] && echo " - $(basename "$script")"
    done
    echo
    echo "✓ Dry run complete (no changes made)"
    return 0
  fi

  echo "→ Applying theme: $theme"

  for script in "$APPLY_DIR"/*.sh; do
    [[ -x "$script" ]] || continue
    echo "→ Running $(basename "$script")"
    THEME_JSON="$tmp" "$script"
  done

  echo "$theme" > "$STATE_FILE"
  echo "✓ Theme applied"
}


validate_theme() {
  local file="$1"

  # basic sanity
  jq -e '.name' "$file" >/dev/null \
    || die "theme missing required field: name"

  # enum validation (explicit > clever)
  local appearance
  appearance="$(jq -r '.macos.appearance // empty' "$file")"

  if [[ -n "$appearance" && "$appearance" != "dark" && "$appearance" != "light" ]]; then
    die "invalid macos.appearance: $appearance (must be dark or light)"
  fi
}


# ------------------------------------------------------------------------------
# Entry point
# ------------------------------------------------------------------------------

case "${1:-}" in
  list)
    cmd_list
    ;;
  current)
    cmd_current
    ;;
  apply)
    shift
    cmd_apply "$@"
    ;;
  doctor)
    cmd_doctor
    ;;
  version)
    cmd_version
    ;;
  explain)
    shift
    cmd_explain "$@"
    ;;
  -h|--help|help|"")
    usage
    ;;
  *)
    die "unknown command: $1"
    ;;
esac